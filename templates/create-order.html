{% extends "base.html" %}
{% block title %}Create order{% endblock %}

{% block content %}
<br>
<h1 align="center">Create order</h1>
<br>

<form class="needs-validation" novalidate method="POST">
<div class="container">
    <div class="card">
        <div class="card-header">
            <h4>Contact information</h4>
        </div>
        <div class="card-body">
            <div class="form-row">
                <div class="col">
                    <div class="input-group has-validation input-group-sm mb-3">
                        <div class="input-group-prepend" >
                          <span class="input-group-text" id="basic-addon1">First name</span>
                        </div>
                        <input type="text" class="form-control" id="name" name="first-name" required pattern="[A-Za-z]{1,32}" aria-label="FirstName" placeholder="e.g. John" aria-describedby="basic-addon1">
                    </div>
                </div>
            </div>
            <div class="form-row">
              <div class="col">
                <div class="input-group input-group-sm mb-3">
                    <div class="input-group-prepend">
                      <span class="input-group-text" id="basic-addon1">Last name</span>
                    </div>
                    <input type="text" class="form-control" id="name" name="last-name" required pattern="[A-Za-z]{1,32}" aria-label="LastName" placeholder="e.g. Smith" aria-describedby="basic-addon1">
                </div>
            </div>
            </div>
            <div class="form-row">
              <div class="col">
                <div class="input-group input-group-sm">
                  <div class="input-group-prepend">
                    <span class="input-group-text" id="basic-addon1">Phone number</span>
                  </div>
                  <input type="tel" id="phone" class="form-control" required name="phone-number" placeholder="e.g. 888-888-8888" aria-label="PhoneNumber" aria-describedby="basic-addon1">
                </div>
            </div>
            </div>
        </div>
    </div>
</div>

<br>

<div class="container">
  <div class="card">
      <div class="card-header">
          <h4>Invoice</h4>
      </div>
      <div class="card-body">
        <table class="table table-sm table-bordered">
          <thead class="thead-light">
            <tr>
              <th scope="col">Item</th>
              <th scope="col">Description</th>
              <th scope="col"></th>
            </tr>
          </thead>
          <tbody id="TBody">
            <tr id="TRow">
              <td class="col-sm" style="width: 50%;">
                <label for="basic-url">Garment</label>
                <select class="custom-select custom-select-sm garmentSelect" required>
                  <option selected disabled></option>
                  {% for garment in garment_list %}
                    <option value="{{ garment.id }}">{{ garment.name }}</option>
                  {% endfor %}
                </select>
                <label class="small-label" for="basic-url">Jobs</label>
                <select class="custom-select custom-select-sm jobSelect" multiple required>
                  <option selected disabled></option>
                </select>
                <label class="small-label" for="basic-url">Price</label>
                <div class="input-group input-group-sm">
                  <div class="input-group-prepend">
                    <span class="input-group-text" id="basic-addon1">$</span>
                  </div>
                  <input type="text" class="form-control price" id="price" required pattern="\d+(\.\d{1,2})?" aria-label="Price" aria-describedby="basic-addon1">
                </div>            
              </td>
              <td style="width: 25%; position: relative;">
                <textarea style="position: absolute; height: 96%; width: 94%;" class="form-control descriptionBox" id="exampleFormControlTextarea1"></textarea>
              </td>
              <td style="width: 1%;" class="NoPrint"><button type="button" class="btn btn-sm btn-danger btn-delete" onclick="BtnDel(this)">X</button></td>
            </tr>
          </tbody>
        </table>
        <div id="wrapper">
        <button type="button" class="btn btn-sm btn-success" onclick="BtnAdd()">+</button>
        </div>
        <br>
        <label for="basic-url">Completion date</label>
        <div class="md-form md-outline input-with-post-icon datepicker">
          <input placeholder="Select date" type="date" id="example" class="form-control form-control-sm" required>
        </div>
      </div>
  </div>
</div>

<br>

<div id="wrapper">
  <button type="submit" class="btn btn-primary">Create</button>
</div>

</form>

<br>
<br>

<script>

function BtnAdd() {
  // Clone the first row
  const newRow = document.getElementById("TRow").cloneNode(true);

  // Clear the selection in the cloned row
  newRow.querySelector(".garmentSelect").selectedIndex = 0;
  newRow.querySelector(".jobSelect").innerHTML = "<option selected disabled></option>"; // Clear job options
  newRow.querySelector(".descriptionBox").value = "";
  newRow.querySelector(".price").value = "";

  // Append the new row to the table body
  document.getElementById("TBody").appendChild(newRow);

  // Get the corresponding garmentSelect and jobSelect elements in the cloned row
  const garmentSelect = newRow.querySelector(".garmentSelect");
  const jobSelect = newRow.querySelector(".jobSelect");
  const priceInput = newRow.querySelector(".price");

  // Add an event listener to handle garment selection updates for dynamically added rows
  if (!newRow.hasAttribute("data-event-listener-added")) {
    newRow.setAttribute("data-event-listener-added", "true");

    garmentSelect.addEventListener("change", function () {
      fetchJobsForGarment(garmentSelect, jobSelect);
      priceInput.value = "";
    });

    jobSelect.addEventListener("change", function () {
      calculateTotalPrice(garmentSelect, jobSelect, priceInput);
    });
  }

  // Show the "X" button in all rows except the first one
  const rows = document.querySelectorAll("#TBody tr");
  rows.forEach((row) => {
    row.querySelector(".btn-delete").style.display = "inline-block";
  });
}

// Attach the event listener to the first row when the page loads
window.addEventListener("DOMContentLoaded", function () {
  const firstRow = document.querySelector("#TBody tr");
  const firstRowGarmentSelect = firstRow.querySelector(".garmentSelect");
  const firstRowJobSelect = firstRow.querySelector(".jobSelect");
  const firstRowPriceInput = firstRow.querySelector(".price");
  firstRowGarmentSelect.addEventListener("change", function () {
    fetchJobsForGarment(firstRowGarmentSelect, firstRowJobSelect);
    priceInput.value = "";
  });
  firstRowJobSelect.addEventListener("change", function () {
      calculateTotalPrice(firstRowGarmentSelect, firstRowJobSelect, firstRowPriceInput);
    });
});

  // Hide the "X" button in the last row if there's only one row left
  const rows = document.querySelectorAll("#TBody tr");
  if (rows.length === 1) {
    rows[0].querySelector(".btn-delete").style.display = "none";
  }

// Function to handle deleting a row
function BtnDel(button) {
  // Get the table row containing the button
  const row = button.parentNode.parentNode;

  // Remove the row from the table body
  row.remove();

  // Hide the "X" button in the last row if there's only one row left
  const rows = document.querySelectorAll("#TBody tr");
  if (rows.length === 1) {
    rows[0].querySelector(".btn-delete").style.display = "none";
  }
}

// Get the input element
const inputElement = document.getElementById("example");

// Get today's date and format it as 'YYYY-MM-DD'
const today = new Date().toISOString().split("T")[0];

// Set the 'min' attribute of the input element to today's date
inputElement.setAttribute("min", today);

const phoneInput = document.getElementById('phone');

phoneInput.addEventListener('input', function() {
  const unformattedValue = phoneInput.value.replace(/\D/g, '');
  const formattedValue = formatPhoneNumber(unformattedValue);
  phoneInput.value = formattedValue;
});

function formatPhoneNumber(number) {
  const numberLength = number.length;
  if (numberLength <= 3) {
    return number;
  } else if (numberLength <= 7) {
    return `${number.slice(0, 3)}-${number.slice(3)}`;
  } else {
    return `${number.slice(0, 3)}-${number.slice(3, 6)}-${number.slice(6, 10)}`;
  }
}

const priceInput = document.getElementById('price');

priceInput.addEventListener('input', function() {
  const unformattedValue = priceInput.value.replace(/[^\d.]/g, ''); // Keep only digits and decimal point
  const formattedValue = formatPrice(unformattedValue); // Format the price as needed
  priceInput.value = formattedValue;
});

function formatPrice(price) {
  // Remove extra decimal points
  price = price.replace(/\.{2,}/g, '.');

  // Limit to two decimal places
  const parts = price.split('.');
  if (parts.length > 1) {
    parts[1] = parts[1].substr(0, 2);
    price = parts.join('.');
  }

  return price;
}

const nameInput = document.getElementById('name');

nameInput.addEventListener('input', function() {
  const cleanedValue = nameInput.value.replace(/[^A-Za-z]/g, '');
  nameInput.value = cleanedValue;
});

function fetchJobsForGarment(selectElement, jobSelect) {
  const garmentId = selectElement.value;

  // Use AJAX to fetch jobs for the selected garment
  fetch(`/get_jobs_for_garment/${garmentId}`)
    .then(response => response.json())
    .then(data => {
      // Remove all options from the job select dropdown of the current row
      while (jobSelect.options.length > 0) {
        jobSelect.remove(0);
      }

      // Add job options for the selected garment to the job select dropdown of the current row
      data.jobs.forEach(job => {
        const option = document.createElement("option");
        option.value = job.id;
        option.text = job.name;
        jobSelect.appendChild(option);
      });
    })
    .catch(error => {
      console.error('Error fetching jobs:', error);
    });
}

// Example starter JavaScript for disabling form submissions if there are invalid fields
(function () {
  'use strict'

  // Fetch all the forms we want to apply custom Bootstrap validation styles to
  var forms = document.querySelectorAll('.needs-validation')

  // Loop over them and prevent submission
  Array.prototype.slice.call(forms)
    .forEach(function (form) {
      form.addEventListener('submit', function (event) {
        if (!form.checkValidity()) {
          event.preventDefault()
          event.stopPropagation()
        }

        form.classList.add('was-validated')
      }, false)
    })
})()

function calculateTotalPrice(garmentSelect, jobSelect, priceInput) {
  const garmentId = garmentSelect.value;
  const selectedJobIds = Array.from(jobSelect.selectedOptions).map(option => option.value);
  if ( !selectedJobIds.length )
  {
    priceInput.value = "";
    return;
  }

  // Use AJAX to fetch the prices for the selected garment and jobs
  fetch(`/calculate_total_price/${garmentId}/${selectedJobIds.join(",")}`)
    .then(response => response.json())
    .then(data => {
      priceInput.value = data.totalPrice;
    })
    .catch(error => {
      console.error('Error calculating total price:', error);
    });
}

</script>
{% endblock %}
